name: Build TWRP for Lenovo Marino

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: archlinux:latest  # Use Arch Linux as the build environment

    steps:
      - name: Set up environment
        run: |
          pacman -Sy --noconfirm sudo base-devel git curl wget python python-pip zip unzip bc \
              flex bison cpio clang lzop libxml2 lzip perl libarchive rsync \
              android-tools ncurses openssl ccache xmlstarlet python-pyelftools
          echo "Build environment setup completed ‚úÖ"

      - name: Clone the Repository
        uses: actions/checkout@v4

      - name: Download Stock Recovery
        run: |
          wget -O recovery.img https://github.com/g-flame-oss/Docker-Projects/raw/refs/heads/main/recovery.img
          ls -lh recovery.img

      - name: Initialize & Sync TWRP Source (Optional)
        run: |
          if [[ "${{ github.event.inputs.skip_repo_sync }}" != "true" ]]; then
            mkdir -p ~/twrp && cd ~/twrp
            repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-8.1
            repo sync --force-sync -j$(nproc)
          else
            echo "Skipping repo sync as requested ‚è©"
          fi

      - name: Generate Device Tree
        run: |
          python3 -m venv twrp-venv
          source twrp-venv/bin/activate
          pip install git+https://github.com/SebaUbuntu/TWRPDeviceTreeGenerator.git
          python -m twrpdtgen recovery.img
          deactivate
          echo "Device tree generation completed ‚úÖ"
      
      - name: Move Device Tree
        run: |
          mkdir -p ~/twrp/device/lenovo/
          mv output/lenovo/marino ~/twrp/device/lenovo/marino
          ls -R ~/twrp/device/lenovo/marino

      - name: Build TWRP Recovery
        run: |
          cd ~/twrp
          . build/envsetup.sh
          lunch omni_marino-eng
          mka recoveryimage -j$(nproc)
          echo "Build completed ‚úÖ"

      - name: Compress Recovery Image
        run: |
          mkdir -p release
          mv ~/twrp/out/target/product/marino/recovery.img release/twrp-marino.img
          cd release
          zip -r twrp-marino.zip twrp-marino.img
          ls -lh twrp-marino.zip
          echo "Recovery image packaged ‚úÖ"

      - name: Upload Device Tree & Recovery Image to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/twrp-marino.zip
          tag_name: latest
          body: |
            üî• **TWRP for Lenovo Marino**  
            - Auto-built on GitHub Actions  
            - Arch-based build system  
            - **Recovery & device tree included!**  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup Unnecessary Files
        run: |
          rm -rf ~/twrp/.repo ~/twrp/out
          echo "Cleanup completed ‚úÖ"
