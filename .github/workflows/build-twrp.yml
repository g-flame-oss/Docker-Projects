name: "🔥 Build TWRP Recovery"

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: 🛠️ Set up environment (Arch Linux chroot)
        run: |
          sudo apt update
          sudo apt install -y arch-install-scripts
          mkdir arch-root && sudo mkarchroot arch-root/root base-devel

      - name: 🚀 Install Dependencies
        run: |
          sudo arch-chroot arch-root/root pacman -Sy --noconfirm sudo base-devel \
              git curl wget python python-pip zip unzip bc \
              flex bison cpio clang lzop libxml2 lzip perl libarchive rsync \
              android-tools ncurses openssl ccache xmlstarlet python-pyelftools
          echo "✅ Installed all dependencies!"

      - name: 🔧 Install repo (Fixes 'repo: command not found')
        run: |
          sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
          sudo chmod +x /usr/local/bin/repo
          echo "✅ Repo installed!"

      - name: 📥 Clone TWRP Source
        run: |
          mkdir -p ~/twrp && cd ~/twrp
          repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-8.1
          repo sync --force-sync -j$(nproc)
          echo "✅ Source code synced successfully!"

      - name: 📤 Download Stock Recovery Image
        run: |
          wget -O ~/twrp/recovery.img https://github.com/g-flame-oss/Docker-Projects/raw/refs/heads/main/recovery.img
          echo "✅ Downloaded stock recovery image!"

      - name: 🏗️ Generate Device Tree
        run: |
          python -m venv ~/twrp/twrp-venv
          source ~/twrp/twrp-venv/bin/activate
          pip install twrpdtgen
          python -m twrpdtgen ~/twrp/recovery.img
          deactivate
          echo "✅ Device tree generated!"

      - name: 📂 Move Device Tree to TWRP Directory
        run: |
          mkdir -p ~/twrp/device/lenovo
          mv ~/twrp/output/lenovo/marino ~/twrp/device/lenovo/marino
          echo "✅ Moved device tree successfully!"

      - name: 🛠️ Build TWRP Recovery
        run: |
          cd ~/twrp
          source build/envsetup.sh
          lunch omni_marino-eng
          mka recoveryimage
          echo "✅ TWRP Recovery Built!"

      - name: 🧹 Clean Unneeded Files
        run: |
          rm -rf ~/twrp/output
          rm -rf ~/twrp/twrp-venv
          echo "✅ Cleaned up unnecessary files!"

      - name: 📤 Upload Recovery Image to Releases
        uses: softprops/action-gh-release
        with:
          files: ~/twrp/out/target/product/marino/recovery.img
          tag_name: "twrp-marino-$(date +'%Y-%m-%d')"
          body: "🔥 TWRP Recovery for Lenovo Marino built successfully! 🎉"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📤 Upload Device Tree to Releases
        uses: softprops/action-gh-release
        with:
          files: ~/twrp/device/lenovo/marino/*
          tag_name: "device-tree-marino-$(date +'%Y-%m-%d')"
          body: "📂 Device Tree for Lenovo Marino generated successfully!"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
